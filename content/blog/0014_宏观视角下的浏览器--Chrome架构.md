---
title: 宏观视角下的浏览器--Chrome架构
date: 2020-03-10
description: Chrome浏览器架构的变化。
tags: ['浏览器']
layout: blog-post
---

**Chrome架构：仅仅打开了1个页面，为什么有4个进程？**今天我们就带着这个疑问，开始Chrome架构的学习吧。


## 浏览器概述

**浏览器背后是标准，标准背后是共识。**

Education is what remains after one has forgotten everything he learned in school.

前端知识大爆炸，应该如何学习前端呢？**通过学习浏览器，搭建自己的知识体系。**

### 浏览器的五大内容
- 浏览器架构设计
- JavaScript引擎工作原理
- 页面工作原理
- 浏览器网络
- 浏览器安全


## 进程和线程
- 多线程可以并行处理任务，但是**线程是不能单独存在的，它是由进程来启动和管理的**。
- **一个进程就是一个程序的运行实例。**也就是说，启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫进程。
- **进程中的任意一线程执行出错，都会导致整个进程的崩溃。**
- **线程之间共享进程中的数据。**
- **当一个进程关闭之后，操作系统会回收进程所占用的内存。**当一个进程退出时，操作系统会回收该进程所申请的所有资源；即使其中任意线程因为操作不当导致内存泄漏，当进程退出时，这些内存也会被正确回收。
- **进程之间的内容相互隔离。**如果进程之间需要进行数据的通信，就需要使用用于进程间通信（IPC）的机制。

![进程的多线程处理](../assets/浏览器/001_multi-thread.png)


## 单进程浏览器时代
**单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里**，这些模块包含了网络、插件、JavaScript 运行环境、渲染引擎和页面等。
![单进程浏览器架构](../assets/浏览器/002_single-process.png)

这么多的功能模块运行在一个进程里，导致单进程浏览器**不稳定、不流畅和不安全**。
- **不稳定**：插件的意外崩溃以及渲染引擎的崩溃都会引起整个浏览器的崩溃。
- **不流畅**：从上图可知，页面的渲染模块、JavaScript执行环境以及插件都是运行在同一个线程中的，这就意味着同一时刻只能有一个模块可以执行。此外，页面若出现内存泄漏，即使关闭页面，也不能完全回收内存，导致时间越长，内存占用越高，浏览器就变得越慢。
- **不安全**：插件可以获取到操作系统的任意资源，页面脚本可以通过浏览器的漏洞来获取系统权限。


## 多进程浏览器时代--早期多进程架构
![早期多进程架构](../assets/浏览器/003_早期多进程架构.png)
- **不稳定问题的解决**：由于进程是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或者插件进程，并不会影响到浏览器和其他页面。
- **不流畅问题的解决**：同理，进程隔离，只会影响当前页面。对于内存泄漏，当关闭页面时，对应的渲染进程也会被关闭，该进程所占用的内存都会被系统回收。
- **不安全问题的解决**：多进程架构可以使用安全沙箱，插件进程和渲染进程都被锁在安全沙箱中，不可操作系统的数据。


## 多进程浏览器时代--目前多进程架构
![目前多进程架构](../assets/浏览器/004_目前多进程架构.png)
最新的Chrome浏览器进程架构包括：1个浏览器（Browser）主进程、1个 GPU 进程、1个网络（NetWork）进程、多个渲染进程和多个插件进程。
- **浏览器进程**。主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。
- **GPU进程**。绘制UI界面。
- **网络进程**。主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的。
- **渲染进程**。核心任务是将HTML、CSS 和 JavaScript转换为用户可以与之交互的网页，排版引擎Blink和JavaScript引擎V8都是运行在该进程中，默认情况下，Chrome会为每个Tab标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。
- **插件进程**。主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

虽然多进程模型提升了浏览器的稳定性、流畅性和安全性，但同样不可避免地带来了一些问题：
- **更高的资源占用**。因为每个进程都会包含公共基础结构的副本（如JavaScript运行环境）。
- **更复杂的体系架构**。浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求了。


## 未来面向服务的架构
面向服务的架构，即Services Oriented Architecture，简称SOA。Chrome整体架构会朝向现代操作系统所采用的“面向服务的架构”方向发展，原来的各种模块会被重构成独立的服务，**每个服务都可以在独立的进程中运行，访问服务必须使用定义好的接口，通过IPC来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统**，更好实现 Chrome 简单、稳定、高速、安全的目标。
![面向服务的架构](../assets/浏览器/005_面向服务架构.png)

同时Chrome还提供灵活的弹性架构，在强大性能设备上会以多进程的方式运行基础服务，但是如果在资源受限的设备上（如下图），Chrome会将很多服务整合到一个进程中，从而节省内存占用。
![面向服务的架构](../assets/浏览器/006_面向服务架构.png)
