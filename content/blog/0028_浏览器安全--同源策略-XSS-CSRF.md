---
title: 浏览器安全--同源策略-XSS-CSRF
date: 2020-03-23
description: 同源策略：为什么XMLHttpRequest不能跨域请求资源？跨站脚本攻击(XSS)：为什么Cookie中有HttpOnly属性？CSRF攻击：陌生链接不要随便点。
tags: ['浏览器']
layout: blog-post
---

浏览器安全可以分为三大块——**Web页面安全、浏览器网络安全和浏览器系统安全**。

## 同源策略：为什么XMLHttpRequest不能跨域请求资源？

### 什么是同源策略
如果两个URL的`协议、域名和端口`都相同，我们就称这两个URL同源。

浏览器默认两个相同的源之间是可以相互访问资源和操作DOM的。**两个不同的源之间若想要`相互访问资源或者操作DOM`，那么会有一套基础的安全策略的制约，我们把这称为同源策略**。

同源策略主要表现在`DOM、Web数据和网络`这三个层面。
- **第一个，DOM层面。**同源策略限制了来自不同源的JavaScript脚本对当前`DOM对象`读和写的操作。
- **第二个，数据层面。**同源策略限制了不同源的站点读取当前站点的`Cookie、IndexDB、LocalStorage`等数据。
- **第三个，网络层面。**同源策略限制了通过`XMLHttpRequest`等方式将站点的数据发送给不同源的站点。

### 安全和便利性的权衡
#### 1 页面中可以嵌入第三方资源
为了解决XSS攻击，浏览器中引入了`内容安全策略`，称为`CSP`。**CSP的核心思想是让服务器决定浏览器能够加载`哪些资源`，让服务器决定浏览器是否能够执行内联JavaScript代码**。

#### 2 跨域资源共享和跨文档消息机制
- **`跨域资源共享（CORS）`，使用该机制可以进行跨域访问控制，从而使跨域数据传输得以安全进行。**
- 为了两个不同源的DOM之间进行通信，浏览器引入了`跨文档消息机制`，可以通过`window.postMessage`的JavaScript接口来和不同源的DOM进行通信。


## 跨站脚本攻击(XSS)：为什么Cookie中有HttpOnly属性？

### 什么是XSS攻击
XSS全称是Cross Site Scripting。XSS攻击是指黑客`往HTML文件中或者DOM中注入恶意脚本`，从而在用户浏览页面时利用注入的恶意脚本对用户实施攻击的一种手段。
- **窃取Cookie信息**。恶意JavaScript可以通过`“document.cookie”`获取Cookie信息。
- **监听用户行为**。恶意JavaScript可以使用`“addEventListener”`接口来监听键盘事件，比如可以获取用户输入的信用卡等信息，将其发送到恶意服务器。
- 通过**修改DOM伪造假的登录窗口**，用来欺骗用户输入用户名和密码等信息。
- **在页面内生成浮窗广告**，这些广告会严重地影响用户体验。

### 恶意脚本是怎么注入的
#### 1 存储型XSS攻击
- 首先`黑客`利用站点漏洞将一段`恶意JavaScript代码`提交到网站的`数据库`中；比如，黑客在页面创建一个名为`<script src="xxx"></script>`的内容。
- 然后用户向网站请求包含了恶意JavaScript脚本的页面；（用户访问上面👆创建的内容的页面）
- 当用户浏览该页面的时候，恶意脚本就会将用户的Cookie信息等数据上传到恶意服务器。（恶意脚本执行，用户的Cookie信息泄露）

#### 2 反射型XSS攻击
- 在一个反射型XSS攻击过程中，恶意JavaScript脚本属于用户发送给网站请求中的一部分，随后网站又把恶意JavaScript脚本返回给用户。当恶意JavaScript脚本在用户页面中被执行时，黑客就可以利用该脚本做一些恶意操作。
- **Web服务器不会存储反射型XSS攻击的恶意脚本，这是和存储型XSS攻击不同的地方。**

举个栗子🌰：
```javascript
var express = require('express')
var router = express.Router()

router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express', xss: req.query.xss })
})

module.exports = router
```

```html
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
</head>
<body>
  <h1><%= title %></h1>
  <p>Welcome to <%= title %></p>
  <div>
    <%- xss %>
  </div>
</body>
</html>
```

- 正常请求：`http://localhost:3000/?xss=123`
- 恶意请求：`http://localhost:3000/?xss=<script>alert('你被xss攻击了')</script>`

#### 3 基于DOM的XSS攻击
- 基于DOM的XSS攻击是不牵涉到页面Web服务器的。
- 具体来讲，黑客通过各种手段将恶意脚本注入用户的页面中，比如通过网络劫持在页面传输过程中修改HTML页面的内容。
- 这种劫持类型很多，有通过WiFi路由器劫持的，有通过本地恶意软件来劫持的，它们的共同点是**在Web资源传输过程或者在用户使用页面的过程中修改Web页面的数据**。

### 如何阻止XSS攻击
- **存储型XSS攻击和反射型XSS攻击**：需要经过Web服务器来处理，属于服务端的安全漏洞。
- **基于DOM的XSS攻击**：在浏览器端完成，属于前端的安全漏洞。
- **共同点**：首先往浏览器中注入恶意脚本，然后再通过恶意脚本将用户信息发送至黑客部署的恶意服务器上。

#### 1 服务器对输入脚本进行过滤或转码

#### 2 充分利用CSP
- `限制加载其他域下的资源文件`，这样即使黑客插入了一个JavaScript文件，这个JavaScript文件也是无法被加载的；
- `禁止向第三方域提交数据`，这样用户数据也不会外泄；
- 禁止执行内联脚本和未授权的脚本；
- 还提供了`上报机制`，这样可以帮助我们尽快发现有哪些XSS攻击，以便尽快修复问题。

#### 3 使用HttpOnly属性
- 由于很多XSS攻击都是来盗用Cookie的，因此还可以通过使用HttpOnly属性来保护Cookie的安全。
- **HttpOnly是服务器通过`HTTP响应头`来设置的**。


## CSRF攻击：陌生链接不要随便点

### 什么是CSRF攻击
- CSRF英文全称是Cross-site request forgery，所以又称为“跨站请求伪造”，是指黑客引诱用户打开黑客的网站，在黑客的网站中，`利用用户的登录状态发起的跨站请求`。
- 简单来讲，**CSRF攻击就是黑客利用了用户的登录状态，并通过第三方的站点来做一些坏事**。

实施CSRF攻击的三种方式：
- **自动发起Get请求**。比如，将请求接口放在img标签的src上。
- **自动发起POST请求**。比如，页面构造隐藏表单，一打开就发起请求。
- **引诱用户点击链接**。

**和XSS不同的是，CSRF攻击不需要将恶意代码注入用户的页面，仅仅是`利用服务器的漏洞和用户的登录状态`来实施攻击。**

### 如何防止CSRF攻击？
发起CSRF攻击的三个必要条件：
- 第一个，目标站点一定要有`CSRF漏洞`；
- 第二个，用户要登录过目标站点，并且在浏览器上保持有该站点的`登录状态`；
- 第三个，需要用户打开一个`第三方站点`，可以是黑客的站点，也可以是一些论坛。

**对于CSRF攻击我们主要的防护手段是提升`服务器`的安全性：**
- 1 充分利用好Cookie的SameSite属性。**从第三方站点发送请求时禁止Cookie的发送。**
- **2 验证请求的来源站点。**`HTTP请求头中的Referer和Origin属性`。Origin属性只包含了域名信息，并没有包含具体的URL路径。
- **3 CSRF Token。**
  - 第一步，在浏览器向服务器发起请求时，`服务器生成一个CSRF Token`。CSRF Token其实就是服务器生成的字符串，然后将该字符串植入到返回的页面中。
  - 第二步，在浏览器端如果要发起转账的请求，那么需要`带上页面中的CSRF Token`，然后服务器会验证该Token是否合法。如果是从第三方站点发出的请求，那么将无法获取到CSRF Token的值，所以即使发出了请求，服务器也会因为CSRF Token不正确而拒绝请求。
