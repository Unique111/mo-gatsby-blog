---
title: 宏观视角下的浏览器--TCP协议与HTTP请求流程
date: 2020-03-11
description: TCP协议：如何保证页面文件能被完整送达浏览器？HTTP请求流程：为什么很多站点第二次打开速度会很快？
tags: ['浏览器']
layout: blog-post
---

带着这些疑问，开始今天的学习：
- **TCP协议：如何保证页面文件能被完整送达浏览器？**
- **HTTP请求流程：为什么很多站点第二次打开速度会很快？**
- **你怎么理解HTTP和TCP的关系？**

优化Web页面的加载速度 => 需要对网络有充分的了解 => 理解网络的关键是要对网络协议有深刻的认识 => **TCP/IP的设计思想**还有助于拓宽我们的知识边界，从而在整体上提升对项目的理解和解决问题的能力。

## TCP协议：如何保证页面文件能被完整送达浏览器？

### 提出问题
- 数据包如何送达主机？
- 主机如何将数据包转交给应用？
- 数据是如何被完整地送达应用程序？

**互联网，实际上是一套理念和协议(规则和标准)组成的体系架构。**

互联网中的数据是通过**数据包**来传输的，数据包在传输过程中容易丢失或出错。如果发送的数据很大，那么该数据就会被拆分为很多小数据包来传输。


### IP：把数据包送达目的主机
**计算机的地址就称为IP地址，访问任何网站实际上只是你的计算机向另外一台计算机请求信息。**

- 如果要想把一个数据包从主机A发送给主机B，那么在传输之前，数据包上会被附加上主机B的IP地址信息，这样在传输过程中才能正确寻址。
- 额外地，数据包上还会附加上主机A本身的IP地址，有了这些信息主机B才可以回复信息给主机A。


### UDP：把数据包送达应用程序
IP是非常底层的协议，只负责把数据包传送到对方电脑，但是对方电脑并不知道把数据包交给哪个程序，所以就需要基于IP之上开发能和应用打交道的协议，最常用的就是UDP协议。

- **UDP中一个最重要的信息是端口号，每个想访问网络的程序都需要绑定一个端口号。**
- **IP通过IP地址信息把数据包发送给指定的电脑，而UDP通过端口号把数据包分发给正确的程序。**
- 对于错误的数据包，UDP并不提供重发机制，只是丢弃当前的包，而且UDP在发送之后也无法知道是否能达到目的地。


### TCP：把数据完整地送达应用程序
**TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。**相对于 UDP，TCP 有下面两个特点:
- 对于数据包丢失的情况，TCP提供`重传机制`；
- TCP引入了`数据包排序机制`，用来保证把乱序的数据包组合成一个完整的文件。
- 因此，TCP头除了包含了目标端口和本机端口号外，还提供了**用于排序的序列号，以便接收端通过序号来重排数据包**。

一个完整的TCP连接的生命周期包括了`“建立连接”“传输数据”和“断开连接”`三个阶段。
![TCP连接的过程](../assets/浏览器/007_TCP连接.png)
- **建立连接阶段**。`面向连接`是指在数据通信开始之前先做好两端之间的准备工作。`三次握手`是指在建立一个TCP连接时，客户端和服务器总共要发送**三个数据包**以确认连接的建立。
- **传输数据阶段**。在该阶段，**接收端需要对每个数据包进行确认操作**，也就是接收端在接收到数据包之后，需要发送确认数据包给发送端。所以当发送端发送了一个数据包之后，在规定时间内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制。同样，一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照TCP头中的序号为其排序，从而保证组成完整的数据。
- **断开连接阶段**。四次挥手来保证双方都能断开连接。


## HTTP请求流程：为什么很多站点第二次打开速度会很快？
HTTP是一种允许浏览器向服务器获取资源的协议，是Web的基础。


### 提出问题
- 为什么通常在第一次访问一个站点时，打开速度很慢，当再次访问这个站点时，速度就很快了？
- 当登录过一个网站之后，下次再访问该站点，就已经处于登录状态了，这是怎么做到的呢？


### 浏览器端发起HTTP请求流程
**1 构建请求**。浏览器构建请求行信息，构建好后，浏览器准备发起网络请求。比如，`GET /index.html HTTP1.1`。

**2 查找缓存**。在真正发起网络请求之前，浏览器会先在`浏览器缓存`(本地保存的资源副本)中查询是否有要请求的文件。若有则直接返回该副本。

**3 准备IP地址和端口**。
HTTP和TCP的关系：
![HTTP和TCP的关系](../assets/浏览器/008_TCP与HTTP的关系.png)
在HTTP工作开始之前，浏览器需要通过TCP与服务器建立连接。也就是说**HTTP的内容是通过TCP的传输数据阶段来实现的**。

- IP地址的获取：**浏览器会请求DNS返回域名对应的IP**。当然浏览器还提供了`DNS数据缓存服务`，如果某个域名已经解析过了，那么浏览器会缓存解析的结果，以供下次查询时直接使用，这样也会减少一次网络请求。
- 端口号：通常情况下，如果URL没有特别指明端口号，那么HTTP协议默认是80端口。

**4 等待TCP队列**。`Chrome有个机制，同一个域名同时最多只能建立6个TCP连接`，如果在同一个域名下同时有10个请求发生，那么其中4个请求会进入排队等待状态，直至进行中的请求完成。

**5 建立TCP连接**。

**6 发送HTTP请求**。
![HTTP请求](../assets/浏览器/009_HTTP请求.png)


### 服务器端处理HTTP请求流程
**1 返回请求**。
![HTTP响应](../assets/浏览器/010_HTTP响应.png)

**2 断开连接**。通常情况下，一旦服务器向客户端返回了请求数据，它就要关闭TCP连接。不过如果浏览器或者服务器在其头信息中加入了：`Connection: Keep-Alive`，那么TCP连接在发送后将仍然保持打开状态，这样浏览器就可以继续通过同一个TCP连接发送请求。**保持TCP连接可以省去下次请求时需要建立连接的时间，提升资源加载速度**。

**3 重定向**。
![HTTP重定向](../assets/浏览器/011_HTTP重定向.png)


### 问题解答
**1 为什么很多站点第二次打开速度会很快？**主要因为`DNS缓存和页面资源缓存`。
浏览器缓存的处理过程：
![浏览器缓存的处理过程](../assets/浏览器/012_浏览器缓存.png)

- 服务器是通过什么方式让浏览器缓存数据的？当服务器返回`HTTP响应头`给浏览器时，浏览器是通过响应头中的`Cache-Control`字段来设置是否缓存该资源。
- `若缓存没过期则直接返回该资源`。否则，重新发起网络请求，并在`HTTP请求头`中带上`If-None-Match`字段。服务器收到请求头后，会根据If-None-Match的值来判断请求的资源是否有更新。
- `若该资源没更新，就返回304状态码`。否则，服务器就直接返回最新资源给浏览器。

**2 登录状态是如何保持的？**
浏览器页面状态是通过使用Cookie来实现的。具体过程为：
- 用户打开登录页面，发起登录请求。
- 服务器收到请求后，验证信息是否正确，若正确，则生成一段表示用户身份的字符串，并把该字符串写到响应头的`Set-Cookie`字段里。
- 浏览器在接收到服务器的响应头后，解析，并把Set-Cookies的值保存在本地。
- 当用户再次访问时，浏览器会在请求头中带上`Cookie`值。

### 总结
![HTTP请求过程](../assets/浏览器/013_HTTP请求过程.png)
